# Feature: 1.2.1 Application Supervisor Structure

## Problem Statement

JidoCode needs a properly structured OTP supervision tree that:
- Provides fault isolation between subsystems
- Manages agent lifecycle via DynamicSupervisor
- Ensures proper startup order (infrastructure before agents)
- Uses appropriate restart strategies

### Impact Analysis
- **Scope**: Core OTP infrastructure for fault tolerance
- **Dependencies**: Depends on task 1.1.1 (project structure) - completed
- **Risk**: Low - standard OTP patterns

## Solution Overview

Update the existing `JidoCode.Application` to add `JidoCode.AgentSupervisor` as a DynamicSupervisor child. The AgentSupervisor will manage LLM agent processes with transient restart strategy.

### Supervision Tree Structure

```
JidoCode.Supervisor (one_for_one)
├── Phoenix.PubSub (JidoCode.PubSub)
├── Registry (JidoCode.AgentRegistry)
└── JidoCode.AgentSupervisor (DynamicSupervisor)
    └── [Agent processes - added dynamically]
```

## Technical Details

### File Locations
- `lib/jido_code/application.ex` - Updated to add AgentSupervisor
- `lib/jido_code/agent_supervisor.ex` - New DynamicSupervisor module
- `test/jido_code/application_test.exs` - Tests for supervision tree

### Key Design Decisions
1. Use DynamicSupervisor for agents (processes added at runtime)
2. Use `:one_for_one` at top level (independent failure handling)
3. AgentSupervisor uses `:one_for_one` strategy internally
4. Agents will register in AgentRegistry for lookup (task 1.2.2)

## Success Criteria

- [x] Application starts without errors
- [x] PubSub, Registry, and AgentSupervisor all running
- [x] `mix run --no-halt` runs for 5+ seconds without crash
- [x] Tests verify supervision tree structure (10 tests)

## Implementation Plan

### Step 1: Create AgentSupervisor module ✅
- [x] Create `JidoCode.AgentSupervisor` as DynamicSupervisor
- [x] Add `count_children/0` and `which_children/0` helper functions

### Step 2: Update Application module ✅
- [x] Add AgentSupervisor to children list
- [x] Verify proper ordering (infrastructure first)

### Step 3: Write tests ✅
- [x] Test supervision tree starts correctly
- [x] Test all children are running (PubSub, Registry, AgentSupervisor)
- [x] Test AgentSupervisor is a DynamicSupervisor
- [x] Test PubSub can subscribe and receive messages
- [x] Test Registry can register and lookup processes

### Step 4: Verify ✅
- [x] Run `mix run --no-halt` for 5+ seconds - success

## Current Status

**Status**: ✅ Complete
**Branch**: `feature/1.2.1-application-supervisor`

### What Works
- Full supervision tree with 3 children
- AgentSupervisor ready for dynamic agent spawning
- 24 total tests passing (10 new application tests)

### Supervision Tree

```elixir
# Children started in order:
1. Phoenix.PubSub (name: JidoCode.PubSub)
2. Registry (keys: :unique, name: JidoCode.AgentRegistry)
3. JidoCode.AgentSupervisor (DynamicSupervisor)
```

### How to Run
```bash
# Run tests
mix test test/jido_code/application_test.exs

# Start application
mix run --no-halt

# In IEx
iex -S mix
JidoCode.AgentSupervisor.count_children()
```
