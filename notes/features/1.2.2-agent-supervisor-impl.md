# Feature: 1.2.2 Agent Supervisor Implementation

## Problem Statement

The AgentSupervisor module needs functions to dynamically start and stop agent processes. Agents must:
- Be spawned under the DynamicSupervisor for fault tolerance
- Register in AgentRegistry for lookup by name
- Use transient restart strategy (restart only on abnormal exit)
- Support graceful termination

### Impact Analysis
- **Scope**: Core agent lifecycle management
- **Dependencies**: Depends on task 1.2.1 (AgentSupervisor structure) - completed
- **Risk**: Low - standard OTP patterns

## Solution Overview

Add `start_agent/1` and `stop_agent/1` functions to the existing AgentSupervisor module. Create a simple GenServer-based agent process for testing the lifecycle management.

### Agent Process Design

```elixir
# Agent specification passed to start_agent/1
%{
  name: :my_agent,        # Registry key for lookup
  module: MyAgent,        # GenServer module
  args: []                # Init arguments
}
```

## Technical Details

### File Locations
- `lib/jido_code/agent_supervisor.ex` - Add start_agent/1, stop_agent/1
- `lib/jido_code/test_agent.ex` - Simple GenServer for testing
- `test/jido_code/agent_supervisor_test.exs` - Lifecycle tests

### Key Design Decisions
1. Use `:transient` restart - agents restart only on crash, not normal exit
2. Register agents via `{:via, Registry, {JidoCode.AgentRegistry, name}}`
3. Support both pid and name-based stop operations
4. Use `DynamicSupervisor.terminate_child/2` for graceful shutdown

### API Design

```elixir
# Start an agent
{:ok, pid} = AgentSupervisor.start_agent(%{
  name: :my_agent,
  module: JidoCode.TestAgent,
  args: []
})

# Stop by pid
:ok = AgentSupervisor.stop_agent(pid)

# Stop by name
:ok = AgentSupervisor.stop_agent(:my_agent)

# Lookup by name
{:ok, pid} = AgentSupervisor.lookup_agent(:my_agent)
```

## Success Criteria

- [x] `start_agent/1` spawns agent under DynamicSupervisor
- [x] Agent registers in AgentRegistry with given name
- [x] `stop_agent/1` terminates agent gracefully
- [x] Agent with `:transient` restart recovers from crash
- [x] Agent with normal exit is not restarted
- [x] Tests verify agent start/stop/restart behavior

## Implementation Plan

### Step 1: Create TestAgent module ✅
- [x] Create simple GenServer for testing lifecycle
- [x] Support crash simulation via message

### Step 2: Implement start_agent/1 ✅
- [x] Accept agent spec with name, module, args
- [x] Build child spec with :transient restart
- [x] Register via AgentRegistry
- [x] Return {:ok, pid} or {:error, reason}

### Step 3: Implement stop_agent/1 ✅
- [x] Accept pid or name
- [x] Lookup pid from name if needed
- [x] Use DynamicSupervisor.terminate_child/2
- [x] Return :ok or {:error, reason}

### Step 4: Implement lookup_agent/1 ✅
- [x] Query AgentRegistry by name
- [x] Return {:ok, pid} or {:error, :not_found}

### Step 5: Write tests ✅
- [x] Test agent starts successfully
- [x] Test agent registers in AgentRegistry
- [x] Test stop by pid
- [x] Test stop by name
- [x] Test crash triggers restart
- [x] Test normal exit does not restart
- [x] Test duplicate name returns error

## Current Status

**Status**: ✅ Complete
**Branch**: `feature/1.2.2-agent-supervisor-impl`

### What Works
- `start_agent/1` spawns agents under DynamicSupervisor
- Agents register in AgentRegistry via `{:via, Registry, ...}` tuple
- `stop_agent/1` works with both pid and name
- `lookup_agent/1` queries Registry for agent pids
- Transient restart strategy correctly restarts crashed agents
- Normal exits do not trigger restart
- 15 new tests, 39 total passing
