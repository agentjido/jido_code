# Feature: 1.3.1 Settings File Structure

## Problem Statement

JidoCode needs a persistent configuration system that:
- Stores user preferences (provider, model) across sessions
- Supports two-level hierarchy: global (~/.jido_code/) and local (./jido_code/)
- Uses JSON format for human readability and easy editing
- Validates settings against a defined schema

### Impact Analysis
- **Scope**: Core configuration persistence for user preferences
- **Dependencies**: Jason for JSON parsing (already in deps)
- **Risk**: Low - standard file operations with JSON

## Solution Overview

Create a `JidoCode.Settings` module that defines:
1. Path constants for global and local settings files
2. JSON schema for valid settings structure
3. Basic read/parse functionality (loading/merging in task 1.3.2)
4. Directory creation helpers for first-time setup

### Settings File Locations

```
~/.jido_code/settings.json     # Global settings (all projects)
./jido_code/settings.json      # Local settings (project-specific, overrides global)
```

### JSON Schema

```json
{
  "provider": "anthropic",
  "model": "claude-3-5-sonnet",
  "providers": ["anthropic", "openai", "openrouter"],
  "models": {
    "anthropic": ["claude-3-5-sonnet", "claude-3-opus"],
    "openai": ["gpt-4o", "gpt-4-turbo"]
  }
}
```

## Technical Details

### File Locations
- `lib/jido_code/settings.ex` - Settings module with paths and schema
- `test/jido_code/settings_test.exs` - Schema validation tests

### Key Design Decisions
1. Use `System.user_home!/0` for cross-platform home directory
2. Use `File.cwd!/0` for local project path
3. Schema validation returns `{:ok, settings}` or `{:error, reason}`
4. All keys are optional (partial settings allowed)
5. Directory creation is lazy (only on write, implemented in 1.3.3)

### API Design (Task 1.3.1 scope)

```elixir
# Path helpers
Settings.global_dir()           # ~/.jido_code
Settings.global_path()          # ~/.jido_code/settings.json
Settings.local_dir()            # ./jido_code
Settings.local_path()           # ./jido_code/settings.json

# Schema validation
Settings.validate(settings_map) # {:ok, settings} | {:error, reason}

# Directory creation (for first write)
Settings.ensure_global_dir()    # :ok | {:error, reason}
Settings.ensure_local_dir()     # :ok | {:error, reason}

# Read single file (raw, no merging - merging in 1.3.2)
Settings.read_file(path)        # {:ok, map} | {:error, reason}
```

## Success Criteria

- [x] Settings module defines global and local paths
- [x] Schema validation accepts valid settings
- [x] Schema validation rejects invalid settings
- [x] Directory creation works for both global and local
- [x] Tests verify schema validation

## Implementation Plan

### Step 1: Create Settings module with path helpers ✅
- [x] Create `JidoCode.Settings` module
- [x] Define `global_dir/0`, `global_path/0`
- [x] Define `local_dir/0`, `local_path/0`

### Step 2: Implement schema validation ✅
- [x] Define valid keys and types
- [x] Implement `validate/1` function
- [x] Return detailed error messages for invalid data

### Step 3: Implement directory creation ✅
- [x] Implement `ensure_global_dir/0`
- [x] Implement `ensure_local_dir/0`
- [x] Handle permission errors gracefully

### Step 4: Implement basic file reading ✅
- [x] Implement `read_file/1` to read and parse JSON
- [x] Handle missing files (return {:error, :not_found})
- [x] Handle malformed JSON with clear errors

### Step 5: Write tests ✅
- [x] Test path helpers return correct paths
- [x] Test valid settings pass validation
- [x] Test invalid settings fail with clear errors
- [x] Test directory creation
- [x] Test file reading with valid/invalid JSON

## Current Status

**Status**: ✅ Complete
**Branch**: `feature/1.3.1-settings-file-structure`

### What Works
- Path helpers for global (`~/.jido_code/`) and local (`./jido_code/`) directories
- Schema validation for all valid keys: provider, model, providers, models
- Directory creation via `ensure_global_dir/0` and `ensure_local_dir/0`
- JSON file reading with proper error handling
- 29 tests covering all functionality
