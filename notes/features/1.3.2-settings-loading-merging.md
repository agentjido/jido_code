# Feature: 1.3.2 Settings Loading and Merging

## Problem Statement

JidoCode needs to load and merge settings from two files with proper precedence:
- Global settings (`~/.jido_code/settings.json`) - base defaults
- Local settings (`./jido_code/settings.json`) - project overrides

The system must:
- Merge settings with local taking precedence over global
- Handle missing files gracefully (treat as empty)
- Handle malformed JSON with logging and fallback
- Cache settings in memory to avoid repeated file reads
- Provide convenient accessor functions

### Impact Analysis
- **Scope**: Core settings access for all JidoCode features
- **Dependencies**: Task 1.3.1 (Settings module with paths and validation) - completed
- **Risk**: Low - standard map merging and caching

## Solution Overview

Add `load/0`, `get/1`, `get/2`, and `reload/0` functions to the existing Settings module. Use an ETS table for caching (accessible across processes) with explicit invalidation.

### Merge Strategy

```
global = {"provider": "anthropic", "model": "claude-3-opus"}
local  = {"model": "gpt-4o"}
merged = {"provider": "anthropic", "model": "gpt-4o"}  # local wins
```

Deep merge for nested `models` map:
```
global.models = {"anthropic": ["claude-3-opus"]}
local.models  = {"openai": ["gpt-4o"]}
merged.models = {"anthropic": ["claude-3-opus"], "openai": ["gpt-4o"]}
```

## Technical Details

### File Locations
- `lib/jido_code/settings.ex` - Add load/get/cache functions
- `test/jido_code/settings_test.exs` - Add merge and cache tests

### Key Design Decisions
1. Use ETS table for cross-process cache (vs Agent or process dictionary)
2. Cache table created on first access (lazy initialization)
3. `reload/0` to explicitly invalidate cache
4. Deep merge only for `models` key (map of lists)
5. Log warnings for malformed JSON but don't fail

### API Design

```elixir
# Load and merge settings (uses cache)
Settings.load()                # {:ok, merged_map}

# Access individual values
Settings.get("provider")       # "anthropic" or nil
Settings.get("model", "default") # value or "default"

# Force reload from disk
Settings.reload()              # {:ok, merged_map}

# Clear cache (for testing)
Settings.clear_cache()         # :ok
```

## Success Criteria

- [x] `load/0` merges global + local with local precedence
- [x] Missing files return empty map (no error)
- [x] Malformed JSON logs warning and returns empty map
- [x] `get/1` and `get/2` access values with optional default
- [x] Settings are cached after first load
- [x] `reload/0` clears cache and reloads
- [x] Tests verify merge precedence

## Implementation Plan

### Step 1: Add ETS cache management ✅
- [x] Create ETS table on first access
- [x] Implement `clear_cache/0`
- [x] Implement cache read/write helpers

### Step 2: Implement load/0 with merging ✅
- [x] Read global settings (empty map if missing/invalid)
- [x] Read local settings (empty map if missing/invalid)
- [x] Deep merge with local precedence
- [x] Cache result
- [x] Return {:ok, settings}

### Step 3: Implement get/1 and get/2 ✅
- [x] Load settings if not cached
- [x] Return value for key or nil/default

### Step 4: Implement reload/0 ✅
- [x] Clear cache
- [x] Call load/0 to reload

### Step 5: Add logging for malformed JSON ✅
- [x] Use Logger.warning for parse errors
- [x] Continue with empty map on error

### Step 6: Write tests ✅
- [x] Test load returns merged settings
- [x] Test local overrides global
- [x] Test deep merge for models
- [x] Test missing files handled gracefully
- [x] Test malformed JSON logs and returns empty
- [x] Test caching (second load doesn't read files)
- [x] Test reload clears cache

## Current Status

**Status**: ✅ Complete
**Branch**: `feature/1.3.2-settings-loading-merging`

### What Works
- `load/0` merges global and local settings with local precedence
- `get/1` and `get/2` for convenient value access
- `reload/0` for forcing cache refresh
- `clear_cache/0` for testing
- ETS-based caching across processes
- Deep merge for `models` key (map of provider -> model list)
- Logger.warning for malformed JSON
- 16 new tests, 84 total passing
