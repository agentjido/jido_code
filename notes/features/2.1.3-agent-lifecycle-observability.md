# Feature: 2.1.3 Agent Lifecycle Observability

**Branch**: `feature/2.1.3-agent-lifecycle-observability`
**Phase**: Phase 2 - LLM Agent with Chain-of-Thought Reasoning

## Problem Statement

The AgentSupervisor manages agent lifecycle but has no observability into agent starts, stops, crashes, or restart patterns. This makes debugging difficult and prevents detection of restart loops that could indicate systematic issues.

## Solution Overview

Create `JidoCode.Telemetry.AgentInstrumentation` module that:
1. Emits telemetry events for agent lifecycle (start, stop, crash)
2. Includes rich metadata (agent name, module, duration, error reason)
3. Provides optional Logger handler for telemetry events
4. Tracks restart counts per agent to detect restart loops

## Technical Details

### Telemetry Events

```elixir
# Agent start
:telemetry.execute(
  [:jido_code, :agent, :start],
  %{system_time: System.system_time()},
  %{name: name, module: module}
)

# Agent stop
:telemetry.execute(
  [:jido_code, :agent, :stop],
  %{duration: duration_native},
  %{name: name, module: module, reason: reason}
)

# Agent crash
:telemetry.execute(
  [:jido_code, :agent, :crash],
  %{duration: duration_native},
  %{name: name, module: module, reason: reason, restart_count: count}
)
```

### Files to Create/Modify

- `lib/jido_code/telemetry/agent_instrumentation.ex` - New telemetry module
- `lib/jido_code/agent_supervisor.ex` - Add telemetry calls
- `test/jido_code/telemetry/agent_instrumentation_test.exs` - Tests

### Dependencies

- `:telemetry` - Already included via Phoenix dependencies

## Implementation Plan

### Step 1: Create AgentInstrumentation module
- [ ] Create `lib/jido_code/telemetry/agent_instrumentation.ex`
- [ ] Define telemetry event names as module attributes
- [ ] Add `emit_start/2` function
- [ ] Add `emit_stop/3` function
- [ ] Add `emit_crash/4` function

### Step 2: Add restart tracking
- [ ] Use ETS table or Agent to track restart counts per agent name
- [ ] Increment count on crash/restart
- [ ] Reset count on normal stop
- [ ] Include restart_count in crash metadata

### Step 3: Add Logger handler
- [ ] Create `attach_logger/1` function accepting log level option
- [ ] Create `detach_logger/0` function
- [ ] Format log messages with agent info and timing

### Step 4: Integrate with AgentSupervisor
- [ ] Emit start event in `start_agent/1`
- [ ] Emit stop event in `stop_agent/1`
- [ ] Track start time in agent metadata for duration calculation

### Step 5: Write tests
- [ ] Test start event emission
- [ ] Test stop event emission
- [ ] Test crash event emission
- [ ] Test restart count tracking
- [ ] Test Logger handler attachment

### Step 6: Update phase plan
- [ ] Mark task complete in phase-02.md
- [ ] Write summary

## Success Criteria

1. Telemetry events emitted for all agent lifecycle transitions
2. Events include name, module, duration, reason metadata
3. Restart counts tracked and included in crash events
4. Optional Logger handler works with configurable log level
5. All tests pass

## Current Status

- [x] Step 1: Create AgentInstrumentation module
- [x] Step 2: Add restart tracking
- [x] Step 3: Add Logger handler
- [x] Step 4: Integrate with AgentSupervisor
- [x] Step 5: Write tests
- [x] Step 6: Update phase plan

## What Works

- `emit_start/2` - Emits telemetry event when agent starts, records start time
- `emit_stop/3` - Emits telemetry event with duration when agent stops normally
- `emit_crash/3` - Emits telemetry event with duration and restart count on crash
- `restart_count/1` - Returns current restart count for an agent
- `reset_restart_count/1` - Manually resets restart count
- `attach_logger/1` - Attaches Logger handler with configurable log level
- `detach_logger/0` - Detaches Logger handler
- AgentSupervisor automatically emits start/stop events

## Files Created/Modified

- `lib/jido_code/telemetry/agent_instrumentation.ex` - New telemetry module
- `lib/jido_code/agent_supervisor.ex` - Added telemetry integration
- `test/jido_code/telemetry/agent_instrumentation_test.exs` - 14 new tests
- `test/jido_code/agent_supervisor_test.exs` - 2 new telemetry tests

## API Examples

```elixir
# Attach logger for debugging
JidoCode.Telemetry.AgentInstrumentation.attach_logger(level: :info)

# Manual event emission (usually done by AgentSupervisor)
AgentInstrumentation.emit_start(:my_agent, MyModule)
AgentInstrumentation.emit_stop(:my_agent, MyModule, :normal)
AgentInstrumentation.emit_crash(:my_agent, MyModule, :crash_reason)

# Check restart count for detecting restart loops
count = AgentInstrumentation.restart_count(:my_agent)

# Attach custom handler
:telemetry.attach(
  "my-handler",
  [:jido_code, :agent, :crash],
  fn _event, _measurements, metadata, _config ->
    if metadata.restart_count > 3 do
      # Alert on restart loop
    end
  end,
  nil
)
```
