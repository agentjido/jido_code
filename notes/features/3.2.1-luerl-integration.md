# Feature 3.2.1: Luerl Integration

## Problem Statement

Tool execution needs sandboxing to prevent unauthorized access to system resources. The LLM agent should not be able to:
- Execute arbitrary shell commands directly
- Access files outside the project directory
- Call dangerous Lua functions like `os.execute`, `io.popen`, `loadfile`

**Impact**: Without sandboxing, the agent could potentially access or modify system files, execute malicious commands, or exfiltrate data.

## Solution Overview

Implement a `JidoCode.Tools.Manager` GenServer that wraps the Luerl Lua runtime for sandboxed tool execution. The Manager:
- Initializes a Lua state with restricted standard library (dangerous functions removed)
- Stores the project root path for path boundary enforcement
- Provides an `execute/3` function for running Lua scripts within the sandbox
- Integrates with the Executor module via the configurable executor function

## Technical Details

### Dependencies

Luerl is already included in mix.exs:
```elixir
{:luerl, "~> 1.2"}
```

### File Structure
```
lib/jido_code/tools/
├── manager.ex           # NEW - GenServer wrapping Luerl sandbox

test/jido_code/tools/
└── manager_test.exs     # NEW - Luerl integration tests
```

### Manager API

```elixir
# Start the manager (via supervision tree)
{:ok, pid} = Manager.start_link(project_root: "/path/to/project")

# Execute a tool script in the sandbox
{:ok, result} = Manager.execute(tool_name, args, timeout \\ 30_000)
{:error, reason} = Manager.execute(tool_name, args, timeout)

# Get current project root
{:ok, path} = Manager.project_root()
```

### Restricted Lua Functions

The following dangerous functions are removed from the Lua state:
- `os.execute` - Shell command execution
- `os.exit` - Process termination
- `io.popen` - Shell command with pipe
- `loadfile` - Load Lua code from file
- `dofile` - Execute Lua file
- `package` - Module loading system
- `require` - Module require

### GenServer State

```elixir
%{
  lua_state: luerl_state(),
  project_root: String.t()
}
```

## Success Criteria

1. Manager starts with a sandboxed Lua state (dangerous functions removed)
2. Project root is stored and accessible
3. `execute/3` runs Lua code and returns results
4. Dangerous functions raise errors when called
5. Manager is added to application supervision tree
6. All tests pass

## Implementation Plan

### Step 1: Create JidoCode.Tools.Manager GenServer
- [x] Define GenServer module with `start_link/1`
- [x] Initialize Lua state using `:luerl.init()`
- [x] Store project root in state
- [x] Write basic tests

### Step 2: Restrict Lua Standard Library
- [x] Remove `os.execute` function
- [x] Remove `os.exit` function
- [x] Remove `io.popen` function
- [x] Remove `loadfile` function
- [x] Remove `dofile` function
- [x] Remove `package` table
- [x] Remove `require` function
- [x] Write tests verifying restrictions

### Step 3: Implement execute/3
- [x] Accept script string, args map, and optional timeout
- [x] Set args as global Lua table
- [x] Execute in sandbox
- [x] Return `{:ok, result}` or `{:error, reason}`
- [x] Write execution tests

### Step 4: Add to Supervision Tree
- [x] Add Manager to Application children
- [x] Configure with default project root (cwd)
- [x] Update application test

### Step 5: Integration Testing
- [x] Test Lua script execution
- [x] Test sandbox restrictions work
- [x] Test argument passing
- [x] Test table encoding/decoding

### Step 6: Update phase plan and create summary
- [x] Mark tasks complete in phase-03.md
- [x] Write summary document

## Current Status

**Status**: Complete
**What Works**: All features implemented and tested
**What's Next**: Task 3.2.2 - Security Boundaries
**How to Run**: `mix test test/jido_code/tools/manager_test.exs`

## Notes

- Using raw `:luerl` module directly rather than the `lua` Elixir wrapper for more control
- The Manager will be the executor function target for the Executor module
- Security boundaries (Task 3.2.2) will build on this foundation
- Bridge functions (Task 3.2.3) will expose controlled Erlang functions to Lua
