# Feature 3.2.2: Security Boundaries

## Problem Statement

The Lua sandbox (Task 3.2.1) blocks dangerous Lua functions, but tool implementations will need to perform file operations. These operations must be restricted to the project directory to prevent:
- Reading sensitive files outside the project (e.g., `/etc/passwd`, `~/.ssh/id_rsa`)
- Writing files outside the project (e.g., system files, other projects)
- Following symlinks that escape the project boundary
- Path traversal attacks using `..` sequences

**Impact**: Without path validation, a malicious or buggy tool could access or modify files anywhere on the system.

## Solution Overview

Create a `JidoCode.Tools.Security` module that provides path validation functions. These will be used by bridge functions (Task 3.2.3) before performing any file operations. The security module:
- Validates paths resolve within the project root
- Detects and blocks path traversal attempts (`..`)
- Handles symlinks by checking their resolved targets
- Logs all security violations for debugging
- Is independent of the Manager (can be used standalone)

Note: Shell execution is already blocked by removing `os.execute` and `io.popen` in Task 3.2.1. Resource limits (memory/time caps) are complex and will be deferred - execution timeout is already handled via GenServer call timeout.

## Technical Details

### File Structure
```
lib/jido_code/tools/
├── manager.ex           # Existing - Lua sandbox
└── security.ex          # NEW - Path validation and security

test/jido_code/tools/
└── security_test.exs    # NEW - Security boundary tests
```

### Security API

```elixir
# Validate a path is within project boundary
Security.validate_path("/project/src/file.ex", "/project")
# => {:ok, "/project/src/file.ex"}

Security.validate_path("../../../etc/passwd", "/project")
# => {:error, :path_escapes_boundary}

Security.validate_path("/etc/passwd", "/project")
# => {:error, :path_outside_boundary}

# Symlink that points outside
Security.validate_path("/project/link_to_etc", "/project")
# => {:error, :symlink_escapes_boundary}
```

### Validation Rules

1. **Absolute paths**: Must start with project root
2. **Relative paths**: Resolved relative to project root, must stay within
3. **Path traversal**: `..` sequences are resolved, result must be within boundary
4. **Symlinks**: Followed and resolved, target must be within boundary
5. **Non-existent paths**: Parent directory must exist and be within boundary

## Success Criteria

1. `validate_path/2` correctly validates paths within project
2. Path traversal attacks are blocked
3. Absolute paths outside project are blocked
4. Symlinks pointing outside are blocked
5. All violations are logged
6. Comprehensive test coverage for attack vectors
7. All tests pass

## Implementation Plan

### Step 1: Create JidoCode.Tools.Security module
- [x] Create module with `validate_path/2` function
- [x] Implement basic path resolution using `Path.expand/2`
- [x] Check if resolved path starts with project root
- [x] Write basic tests

### Step 2: Handle path traversal attacks
- [x] Resolve `..` sequences before validation
- [x] Test various traversal patterns
- [x] Test edge cases (multiple `..`, mixed with valid paths)

### Step 3: Handle symlinks
- [x] Use `File.read_link/1` to detect symlinks
- [x] Recursively resolve symlink chains
- [x] Validate final target is within boundary
- [x] Write symlink tests

### Step 4: Add security violation logging
- [x] Log warnings for all blocked paths
- [x] Include violation type and attempted path
- [x] Make logging configurable (for testing)

### Step 5: Integration with Manager
- [x] Add `validate_path/1` to Manager using stored project_root
- [x] Update Manager docs

### Step 6: Comprehensive security tests
- [x] Test all attack vectors
- [x] Test edge cases
- [x] Test logging

### Step 7: Update phase plan and create summary
- [x] Mark tasks complete in phase-03.md
- [x] Write summary document

## Current Status

**Status**: Complete
**What Works**: All features implemented and tested
**What's Next**: Task 3.2.3 - Erlang Bridge Functions
**How to Run**: `mix test test/jido_code/tools/security_test.exs`

## Notes

- Resource limits (memory cap, execution time cap) are deferred - the GenServer call timeout already provides time limits
- Shell execution blocking is already done in Task 3.2.1
- The Security module is designed to be used by bridge functions in Task 3.2.3
- Symlink handling requires careful testing with actual filesystem symlinks
