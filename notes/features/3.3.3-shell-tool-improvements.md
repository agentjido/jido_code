# Feature 3.3.3-improvements: Shell Tool Security and Quality Improvements

## Problem Statement

The shell execution tool (Task 3.3.3) was reviewed and identified with 2 blockers, 8 concerns, and 3 suggestions for improvement. This feature addresses all items from the review document at `notes/reviews/3.3.3-shell-execution-tool-review.md`.

**Impact**: Without these fixes, the shell tool has critical security vulnerabilities and code quality inconsistencies with other handler modules.

## Solution Overview

Implement all fixes from the code review:

1. **Security Blockers**: Command allowlist and shell interpreter blocking
2. **Code Quality Concerns**: Timeout alignment, format_error helper, typespecs, missing tests, documentation updates
3. **Suggestions**: Output size limits, specific catch patterns, path validation for arguments

## Implementation Plan

### Step 1: Implement Command Allowlist (Blocker #1)
- [x] 1.1 Add `@allowed_commands` module attribute with safe commands
- [x] 1.2 Add `@blocked_commands` for dangerous commands (shell interpreters)
- [x] 1.3 Implement `validate_command/1` function
- [x] 1.4 Integrate validation into `execute/2` flow
- [x] 1.5 Add tests for allowed/blocked commands

### Step 2: Block Shell Interpreters (Blocker #2)
- [x] 2.1 Define `@shell_interpreters` list (bash, sh, zsh, fish, dash, ksh)
- [x] 2.2 Block shell interpreters in `validate_command/1`
- [x] 2.3 Update test that uses bash for stderr capture
- [x] 2.4 Add tests for shell interpreter blocking

### Step 3: Fix Timeout Issue (Concern #3)
- [x] 3.1 Change `@default_timeout` from 60_000 to 25_000 (below Executor's 30s)
- [x] 3.2 Update tool description to reflect new default
- [x] 3.3 Update tests that rely on timeout value

### Step 4: Add format_error Helper (Concern #4)
- [x] 4.1 Add `format_error/2` function to Shell module (matching FileSystem pattern)
- [x] 4.2 Add error types: :enoent, :eacces, :enomem, :command_not_allowed, :shell_blocked
- [x] 4.3 Update catch clauses to use format_error
- [x] 4.4 Add tests for error formatting

### Step 5: Add Typespecs (Concern #6)
- [x] 5.1 Add @spec for get_project_root/1
- [x] 5.2 Add @spec for format_error/2
- [x] 5.3 Add @spec for validate_command/1
- [x] 5.4 Add @spec for execute/2 in RunCommand
- [x] 5.5 Add @spec for private functions (parse_args, execute_with_timeout, run_command)

### Step 6: Add Missing Tests (Concern #7)
- [x] 6.1 Add batch execution tests to definitions test
- [x] 6.2 Add unknown parameter rejection test
- [x] 6.3 Add test for non-list args parameter
- [x] 6.4 Add tests for command validation errors

### Step 7: Update Documentation (Concern #8)
- [x] 7.1 Update summary document with architectural decision note
- [x] 7.2 Update tool description with stderr merging behavior (Concern #9)

### Step 8: Implement Output Size Limits (Suggestion #11)
- [x] 8.1 Add `@max_output_size` constant (default: 1MB)
- [x] 8.2 Truncate output with "[truncated]" suffix when exceeded
- [x] 8.3 Add test for output truncation

### Step 9: Add Specific Catch Patterns (Suggestion #12)
- [x] 9.1 Add specific handler for :eacces (permission denied)
- [x] 9.2 Add specific handler for :enomem (out of memory)
- [x] 9.3 Keep catch-all for unexpected errors

### Step 10: Validate Path Arguments (Suggestion #13)
- [x] 10.1 Add path validation for arguments that look like file paths
- [x] 10.2 Block arguments containing path traversal patterns (../)
- [x] 10.3 Block absolute paths outside project root
- [x] 10.4 Add tests for path argument validation

### Step 11: Final Verification
- [x] 11.1 Run all tests
- [x] 11.2 Run Credo strict
- [x] 11.3 Update phase-03.md (mark 3.3.3.6 as complete)
- [x] 11.4 Write summary document

## Technical Details

### Command Allowlist

```elixir
@allowed_commands ~w(
  mix elixir iex
  git
  npm npx yarn pnpm node
  cargo rustc
  go
  python python3 pip pip3
  ls cat head tail grep find wc diff sort uniq
  test true false echo printf
  mkdir rmdir cp mv ln touch
  date time sleep
)

@shell_interpreters ~w(bash sh zsh fish dash ksh csh tcsh ash)
```

### Output Truncation

```elixir
@max_output_size 1_048_576  # 1MB

defp maybe_truncate(output) when byte_size(output) > @max_output_size do
  truncated = binary_part(output, 0, @max_output_size)
  truncated <> "\n\n[Output truncated at 1MB]"
end
defp maybe_truncate(output), do: output
```

### Path Argument Validation

```elixir
defp validate_args(args, project_root) do
  Enum.reduce_while(args, {:ok, []}, fn arg, {:ok, acc} ->
    case validate_arg(arg, project_root) do
      {:ok, safe_arg} -> {:cont, {:ok, acc ++ [safe_arg]}}
      {:error, reason} -> {:halt, {:error, reason}}
    end
  end)
end

defp validate_arg(arg, project_root) do
  cond do
    String.contains?(arg, "..") ->
      {:error, :path_traversal_blocked}
    String.starts_with?(arg, "/") and not String.starts_with?(arg, project_root) ->
      {:error, :absolute_path_blocked}
    true ->
      {:ok, to_string(arg)}
  end
end
```

## Success Criteria

1. All 13 review items addressed
2. All existing tests pass
3. New tests for security features pass
4. Credo strict passes
5. Documentation updated

## Current Status

**Status**: Complete
**What Works**: All blockers, concerns, and suggestions implemented
**What's Next**: Commit and merge
**How to Run**: `mix test test/jido_code/tools/handlers/shell_test.exs test/jido_code/tools/definitions/shell_test.exs`

## Notes

- The command allowlist is configurable but defaults to safe development commands
- Shell interpreters are completely blocked (bash, sh, etc.)
- Path validation blocks directory traversal attacks via arguments
- Output truncation prevents memory exhaustion from large outputs
- Timeout reduced to 25s to work within Executor's 30s default
