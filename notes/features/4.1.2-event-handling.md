# Feature 4.1.2: Event Handling

## Problem Statement

The TUI module has placeholder implementations for `event_to_msg/2` and `update/2`. These need to be implemented to handle user input (keyboard events) and update the Model state accordingly.

**Impact**: Without event handling, users cannot interact with the TUI - no typing, submitting prompts, or quitting.

## Solution Overview

Implement the Elm Architecture event handling flow:

1. `event_to_msg/2` - Convert TermUI events (keyboard, mouse, etc.) to application messages
2. `update/2` - Process messages and update Model state

### Message Types

Define these message types for the TUI:

- `:key_input` - Printable character input, backspace
- `:submit` - Enter key pressed (submit current input)
- `:agent_response` - Response from agent (PubSub)
- `:status_update` - Agent status change (PubSub)
- `:config_change` - Configuration changed (PubSub)
- `:quit` - Ctrl+C pressed

### Keyboard Mappings

| Event | Message |
|-------|---------|
| Enter | `{:submit, input_buffer}` |
| Printable char | `{:key_input, char}` |
| Backspace | `{:key_input, :backspace}` |
| Ctrl+C | `:quit` |
| Other | `:ignore` |

## Implementation Plan

### Step 1: Define Message Types
- [x] 1.1 Document message type specs in module
- [x] 1.2 Add type definitions for each message variant

### Step 2: Implement event_to_msg/2
- [x] 2.1 Handle Enter key → `{:submit, input_buffer}`
- [x] 2.2 Handle printable characters → `{:key_input, char}`
- [x] 2.3 Handle Backspace → `{:key_input, :backspace}`
- [x] 2.4 Handle Ctrl+C → `:quit`
- [x] 2.5 Return `:ignore` for unhandled events

### Step 3: Implement update/2
- [x] 3.1 Handle `{:key_input, char}` - append to input_buffer
- [x] 3.2 Handle `{:key_input, :backspace}` - remove last char from input_buffer
- [x] 3.3 Handle `{:submit, text}` - clear buffer, add user message
- [x] 3.4 Handle `:quit` - return quit command
- [x] 3.5 Handle PubSub messages (agent_response, status_update, config_change)

### Step 4: Write Tests
- [x] 4.1 Test event_to_msg/2 for each event type
- [x] 4.2 Test update/2 state transitions
- [x] 4.3 Test input buffer operations
- [x] 4.4 Test message history updates

### Step 5: Update Documentation
- [ ] 5.1 Mark task complete in phase-04.md
- [ ] 5.2 Write summary document

## Technical Details

### TermUI Event Structure

From TermUI.Event module:

```elixir
# Key event structure
%TermUI.Event.Key{
  key: atom(),       # :enter, :backspace, :a, :b, etc.
  char: String.t(),  # "a", "B", etc. or nil
  modifiers: [atom()], # [:ctrl], [:shift], etc.
  timestamp: integer()
}
```

### event_to_msg/2 Implementation

```elixir
def event_to_msg(%Event.Key{key: :enter}, _state) do
  {:submit}
end

def event_to_msg(%Event.Key{key: :backspace}, _state) do
  {:key_input, :backspace}
end

def event_to_msg(%Event.Key{key: :c, modifiers: modifiers}, _state) when :ctrl in modifiers do
  :quit
end

def event_to_msg(%Event.Key{char: char}, _state) when is_binary(char) and char != "" do
  {:key_input, char}
end

def event_to_msg(_event, _state) do
  :ignore
end
```

### update/2 Implementation

```elixir
def update({:key_input, char}, state) when is_binary(char) do
  new_buffer = state.input_buffer <> char
  {%{state | input_buffer: new_buffer}, []}
end

def update({:key_input, :backspace}, state) do
  new_buffer = String.slice(state.input_buffer, 0..-2//1)
  {%{state | input_buffer: new_buffer}, []}
end

def update({:submit}, state) do
  text = String.trim(state.input_buffer)
  if text == "" do
    {state, []}
  else
    message = %{role: :user, content: text, timestamp: DateTime.utc_now()}
    new_state = %{state |
      input_buffer: "",
      messages: state.messages ++ [message]
    }
    {new_state, []}
  end
end

def update(:quit, state) do
  {state, [:quit]}
end
```

## Success Criteria

1. Enter key submits current input
2. Printable characters append to input buffer
3. Backspace removes last character
4. Ctrl+C triggers quit
5. All tests pass
6. Credo checks pass

## Current Status

**Status**: Complete
**What Works**: Full keyboard event handling and state updates
**What's Next**: Task 4.1.3 PubSub Integration
**How to Run**: `mix test test/jido_code/tui_test.exs`
