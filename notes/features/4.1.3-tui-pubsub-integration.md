# Feature: 4.1.3 TUI PubSub Integration

## Problem Statement

Task 4.1.3 requires connecting the TUI to agent events via Phoenix PubSub. The TUI needs to receive real-time updates for:
- Agent responses
- Status changes (idle, processing, error)
- Reasoning steps (Chain-of-Thought progress)
- Configuration changes

## Solution Overview

### Architecture Challenge

TermUI's Elm architecture only processes events via `event_to_msg/2` for terminal events (Key, Mouse, Resize, etc.). Phoenix PubSub messages arrive as regular Erlang messages (`handle_info`) but the TermUI Runtime doesn't forward these to Elm components.

### Solution: PubSub Bridge

Create a separate GenServer (`JidoCode.TUI.PubSubBridge`) that:
1. Subscribes to the `"tui.events"` PubSub topic
2. Converts PubSub messages to Elm messages
3. Forwards to the TUI Runtime via `TermUI.Runtime.send_message/3`

### Message Flow

```
Agent Process
     │
     ▼ Phoenix.PubSub.broadcast("tui.events", msg)
┌─────────────────┐
│ JidoCode.PubSub │
└────────┬────────┘
         │
         ▼ handle_info
┌─────────────────────────┐
│ JidoCode.TUI.PubSubBridge│
└────────────┬────────────┘
             │
             ▼ TermUI.Runtime.send_message(runtime, :root, msg)
┌─────────────────────────┐
│ TermUI Runtime          │
│   └─ JidoCode.TUI       │ ◄── update/2 receives msg
└─────────────────────────┘
```

## Implementation Plan

### Step 1: Create PubSub Bridge
- [x] 1.1 Create `lib/jido_code/tui/pubsub_bridge.ex`
- [x] 1.2 Implement GenServer that subscribes to `"tui.events"`
- [x] 1.3 Forward messages to TUI Runtime via `send_message/3`

### Step 2: Update TUI Module
- [x] 2.1 Remove PubSub subscription from `init/1` (moved to bridge)
- [x] 2.2 Update `run/0` to register Runtime with a name
- [x] 2.3 Start PubSubBridge after Runtime starts

### Step 3: Implement Message Handlers
- [x] 3.1 Handle `{:agent_response, content}` - add assistant message
- [x] 3.2 Handle `{:agent_status, status}` - update agent_status
- [x] 3.3 Handle `{:reasoning_step, step}` - add/update reasoning steps
- [x] 3.4 Handle `{:config_changed, config}` - update config and status

### Step 4: Write Tests
- [x] 4.1 Test PubSubBridge forwards messages
- [x] 4.2 Test update/2 for agent_response
- [x] 4.3 Test update/2 for agent_status
- [x] 4.4 Test update/2 for reasoning_step
- [x] 4.5 Test update/2 for config_changed

### Step 5: Verify
- [x] 5.1 Run `mix compile` successfully
- [x] 5.2 Run `mix test` - all tests pass

## Technical Notes

### PubSub Message Types

```elixir
# Agent completed response
{:agent_response, %{content: String.t()}}

# Agent status changed
{:agent_status, :idle | :processing | :error}

# Reasoning step update
{:reasoning_step, %{step: String.t(), status: :pending | :active | :complete}}

# Configuration changed (e.g., model switch)
{:config_changed, %{provider: String.t(), model: String.t()}}
```

### TUI Runtime Registration

```elixir
# In JidoCode.TUI.run/0
def run do
  # Start runtime with registered name
  {:ok, _pid} = TermUI.Runtime.start_link(
    root: __MODULE__,
    name: __MODULE__.Runtime
  )

  # Start PubSub bridge pointing to runtime
  {:ok, _bridge} = PubSubBridge.start_link(runtime: __MODULE__.Runtime)

  # Block until runtime exits
  receive do
    {:DOWN, _, :process, _, _} -> :ok
  end
end
```

## Success Criteria

1. PubSub messages are received by the TUI
2. Agent responses appear in conversation history
3. Status indicator updates in real-time
4. Reasoning steps display during CoT queries
5. Config changes are reflected immediately
6. All tests pass

## Current Status

**Status**: Complete
