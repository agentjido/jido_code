# Feature 4.2.2: Message Display

## Problem Statement

The current message display is basic - it shows messages with role prefixes but lacks:
1. Text wrapping for long messages (messages overflow terminal width)
2. Timestamp display (users can't see when messages were sent)
3. Manual scrolling (users can only see the most recent messages)

**Impact**: Long messages are truncated/overflow, users lose context of when conversations happened, and can't review earlier messages.

## Solution Overview

Enhance the message display with:
1. Text wrapping based on terminal width
2. Timestamp display (HH:MM format)
3. Scroll offset in Model for manual navigation
4. Arrow key handling for scrolling through history

### Already Implemented (from 4.2.1)
- `render_messages/2` helper function ✓
- User messages with "You:" prefix in cyan ✓
- Assistant messages with "Assistant:" prefix ✓
- Auto-scroll to latest message (takes last N lines) ✓

### Needs Implementation
- Text wrapping for long messages
- Timestamp display
- Scroll offset support with arrow key navigation

## Implementation Plan

### Step 1: Add scroll_offset to Model
- [x] 1.1 Add `scroll_offset` field to Model struct (default: 0)
- [x] 1.2 Update init/1 to include scroll_offset
- [x] 1.3 Add type spec for scroll_offset

### Step 2: Implement Text Wrapping
- [x] 2.1 Create `wrap_text/2` helper (text, max_width)
- [x] 2.2 Update format_message/1 to use wrapping
- [x] 2.3 Pass window width to format_message

### Step 3: Add Timestamp Display
- [x] 3.1 Create `format_timestamp/1` helper
- [x] 3.2 Update format_message to include timestamp
- [x] 3.3 Format as "HH:MM" for brevity

### Step 4: Implement Scroll Navigation
- [x] 4.1 Handle Up arrow → {:scroll, :up} in event_to_msg
- [x] 4.2 Handle Down arrow → {:scroll, :down} in event_to_msg
- [x] 4.3 Implement update for {:scroll, direction}
- [x] 4.4 Apply scroll_offset in render_messages

### Step 5: Write Tests
- [x] 5.1 Test wrap_text with various inputs
- [x] 5.2 Test timestamp formatting
- [x] 5.3 Test scroll offset updates
- [x] 5.4 Test arrow key event handling

### Step 6: Documentation
- [x] 6.1 Update phase-04.md marking task complete
- [x] 6.2 Write summary document

## Technical Details

### Text Wrapping Algorithm

```elixir
defp wrap_text(text, max_width) when max_width > 0 do
  text
  |> String.split(" ")
  |> Enum.reduce({[], ""}, fn word, {lines, current_line} ->
    new_line = if current_line == "", do: word, else: current_line <> " " <> word
    if String.length(new_line) <= max_width do
      {lines, new_line}
    else
      if current_line == "" do
        # Word is longer than max_width, split it
        {lines ++ [String.slice(word, 0, max_width)], String.slice(word, max_width..-1//1)}
      else
        {lines ++ [current_line], word}
      end
    end
  end)
  |> then(fn {lines, last} ->
    if last == "", do: lines, else: lines ++ [last]
  end)
end
```

### Scroll Offset Logic

```elixir
def update({:scroll, :up}, state) do
  # Scroll up (towards older messages)
  new_offset = min(state.scroll_offset + 1, max_scroll(state))
  {%{state | scroll_offset: new_offset}, []}
end

def update({:scroll, :down}, state) do
  # Scroll down (towards newer messages)
  new_offset = max(state.scroll_offset - 1, 0)
  {%{state | scroll_offset: new_offset}, []}
end
```

### Message Format with Timestamp

```
[14:32] You: Hello there
[14:32] Assistant: Hi! How can I help you today?
```

## Success Criteria

1. Long messages wrap at terminal width
2. Each message shows timestamp in [HH:MM] format
3. Up/Down arrows scroll through message history
4. scroll_offset persists during session
5. All tests pass
6. Credo checks pass

## Current Status

**Status**: Complete
**What Works**: Text wrapping, timestamps, scroll navigation with arrow keys
**What's Next**: Task 4.2.3 Reasoning Panel
**How to Run**: `mix test test/jido_code/tui_test.exs`
