# Feature: 4.2.2 TUI Message Display

## Problem Statement

Task 4.2.2 requires enhancing message display in the TUI with text wrapping for long messages, auto-scroll to show the latest message, and support for scrolling through message history with arrow keys.

Note: Basic message display with timestamps and role styling was implemented in 4.2.1. This task adds:
- Text wrapping for long messages
- Auto-scroll to latest message
- Arrow key scrolling through history

## Solution Overview

### Model Changes

Add `scroll_offset` field to track the current scroll position in the message history:
- `scroll_offset: 0` means showing the latest messages (bottom)
- Positive values scroll up through history

### Event Handling

Add arrow key handlers:
- Up arrow: Scroll up (increase offset)
- Down arrow: Scroll down (decrease offset, min 0)
- Page Up: Scroll up by page
- Page Down: Scroll down by page

### Text Wrapping

Implement word-aware text wrapping that respects terminal width:
- Calculate available width from window dimensions
- Wrap message content at word boundaries when possible
- Preserve the role prefix on the first line only

## Implementation Plan

### Step 1: Update Model
- [x] 1.1 Add `scroll_offset` field to Model struct (default: 0)
- [x] 1.2 Update Model typespec

### Step 2: Add Event Handlers
- [x] 2.1 Add event_to_msg handler for Up arrow → `:scroll_up`
- [x] 2.2 Add event_to_msg handler for Down arrow → `:scroll_down`
- [x] 2.3 Add update handler for `:scroll_up`
- [x] 2.4 Add update handler for `:scroll_down`
- [x] 2.5 Reset scroll_offset to 0 on new message (auto-scroll)

### Step 3: Implement Text Wrapping
- [x] 3.1 Create `wrap_text/2` helper function
- [x] 3.2 Update render_message to use text wrapping
- [x] 3.3 Calculate wrap width from window dimensions

### Step 4: Update Message Rendering
- [x] 4.1 Pass state to render_messages for window dimensions
- [x] 4.2 Apply scroll_offset to determine visible messages
- [x] 4.3 Calculate visible message count based on window height

### Step 5: Write Tests
- [x] 5.1 Test scroll_offset in Model
- [x] 5.2 Test arrow key event handling
- [x] 5.3 Test scroll update handlers
- [x] 5.4 Test auto-scroll on new message
- [x] 5.5 Test text wrapping function

### Step 6: Verify
- [x] 6.1 Run `mix compile` successfully
- [x] 6.2 Run `mix test` - all tests pass

## Technical Notes

### Text Wrapping Algorithm

```elixir
def wrap_text(text, max_width) do
  text
  |> String.split(" ")
  |> Enum.reduce({[], ""}, fn word, {lines, current_line} ->
    candidate = if current_line == "", do: word, else: current_line <> " " <> word
    if String.length(candidate) <= max_width do
      {lines, candidate}
    else
      {lines ++ [current_line], word}
    end
  end)
  |> then(fn {lines, last} -> lines ++ [last] end)
  |> Enum.reject(&(&1 == ""))
end
```

### Scroll Offset Calculation

- `total_messages` = length of messages list
- `visible_lines` = window height - 3 (status bar, input bar, margins)
- `max_offset` = max(0, total_messages - visible_lines)
- `scroll_offset` = clamp(scroll_offset, 0, max_offset)

### Auto-Scroll Behavior

When a new message is added (via submit or agent_response):
- Reset `scroll_offset` to 0 to show the latest message

## Success Criteria

1. Long messages wrap at word boundaries
2. Up/Down arrows scroll through message history
3. New messages auto-scroll to bottom
4. Scroll offset is bounded correctly
5. All tests pass

## Current Status

**Status**: Complete
