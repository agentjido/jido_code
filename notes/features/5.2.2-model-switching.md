# Feature: 5.2.2 Model Switching

## Problem Statement

Task 5.2.1 implemented the command parser, but it only updates settings and TUI state. When a user switches models, the running LLMAgent needs to be reconfigured to actually use the new model. Additionally, we should validate that the user has an API key for the selected provider.

## Solution Overview

Extend the Commands module to:
1. Validate API key exists for the provider before switching
2. Call `LLMAgent.configure/2` to update the running agent
3. Broadcast config change via PubSub for any listeners

Note: Most of the task subtasks are already complete from 5.2.1:
- 5.2.2.1 ✓ Parse provider and model name
- 5.2.2.2 ✓ Validate provider exists
- 5.2.2.7 ✓ Save to settings
- 5.2.2.9 ✓ Display success/error in TUI

Remaining work:
- 5.2.2.3 Model validation (skipped intentionally for flexibility)
- 5.2.2.5 API key validation
- 5.2.2.6 LLMAgent.configure/2 call
- 5.2.2.8 Broadcast config change
- 5.2.2.10 Integration tests

## Technical Details

### Files to Modify
- `lib/jido_code/commands.ex` - Add API key validation and agent configuration

### Dependencies
- `Jido.AI.Keyring` - For checking API key existence
- `JidoCode.Agents.LLMAgent` - For reconfiguring the agent
- `JidoCode.AgentSupervisor` - For looking up the agent
- `Phoenix.PubSub` - For broadcasting config changes

### API Key Lookup

Keyring maps provider names to environment variable keys:
- `anthropic` → `:anthropic_api_key`
- `openai` → `:openai_api_key`
- etc.

Check with: `Jido.AI.Keyring.get(:anthropic_api_key)` returns nil if not set.

## Implementation Plan

### Step 1: Add API key validation to Commands
- [ ] 1.1 Add `validate_api_key/1` function
- [ ] 1.2 Call validation in `set_provider_and_model/2`
- [ ] 1.3 Show helpful error when API key missing

### Step 2: Add agent reconfiguration
- [ ] 2.1 Look up LLMAgent via AgentSupervisor in Commands
- [ ] 2.2 Call LLMAgent.configure/2 after settings update
- [ ] 2.3 Handle agent not running case gracefully

### Step 3: Add config broadcast
- [ ] 3.1 Broadcast `{:config_changed, old_config, new_config}` via PubSub
- [ ] 3.2 Use session topic from TUI

### Step 4: Write integration tests
- [ ] 4.1 Test API key validation prevents switch when missing
- [ ] 4.2 Test successful model switch calls configure
- [ ] 4.3 Test config broadcast is sent

## Success Criteria

1. `/model anthropic:claude-3-5-sonnet` fails with helpful error if no API key
2. With API key, model switch reconfigures running agent
3. Config change broadcast sent on success
4. All tests pass

## Current Status

**Status**: Complete
**What Works**: All features implemented and tested
- API key validation with helpful error messages
- LLMAgent.configure/2 call on model switch
- Config broadcast via PubSub
- Integration tests with Keyring session value mocking
