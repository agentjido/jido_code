# Summary: 3.2.1 Luerl Integration

## Overview

Implemented a Lua sandbox for tool execution using the Luerl library. The `JidoCode.Tools.Manager` GenServer wraps the Lua runtime with dangerous functions removed for security, enabling safe execution of Lua scripts with Elixir argument passing.

## Files Created

### lib/jido_code/tools/manager.ex
GenServer wrapping Luerl for sandboxed Lua execution:
- `start_link/1` - Start with optional `:project_root` and `:name`
- `execute/3` - Execute Lua script with args map and optional timeout
- `project_root/0` - Get configured project root path
- `restricted?/1` - Check if function path is blocked

Sandbox restrictions (dangerous functions removed):
- `os.execute` - Shell command execution
- `os.exit` - Process termination
- `io.popen` - Shell command with pipe
- `loadfile` - Load Lua code from file
- `dofile` - Execute Lua file
- `package` - Module loading system
- `require` - Module require

Key implementation details:
- Uses `:luerl.init()` to create fresh Lua state
- Applies sandbox by setting restricted functions to `nil`
- Uses `:luerl.encode/2` for proper table encoding of args
- Decodes results including table references with `:luerl.decode/2`
- Detects and converts Lua arrays (sequential integer keys) to Elixir lists
- Converts Lua tables with string keys to Elixir maps

### test/jido_code/tools/manager_test.exs
36 tests covering:
- GenServer startup with various options
- Basic Lua execution (numbers, strings, booleans, nil)
- Argument passing (scalars, nested maps, arrays)
- Table result decoding (maps, arrays, nested)
- Error handling (syntax errors, runtime errors)
- Sandbox restrictions (all 7 dangerous functions blocked)
- Allowed functions still work (os.time, string.upper, math.sqrt)
- Execution isolation (global state doesn't persist between calls)

### Modified Files

**lib/jido_code/application.ex**
- Added `JidoCode.Tools.Manager` to supervision tree (6 children total)

**test/jido_code/application_test.exs**
- Updated to expect 6 supervisor children
- Added assertion for `JidoCode.Tools.Manager` presence

## Design Decisions

1. **Direct Luerl Usage**: Used raw `:luerl` module instead of the `lua` Elixir wrapper for more control over encoding/decoding and sandbox application.

2. **Stateless Execution**: Each `execute/3` call uses the original Lua state (globals don't persist). This provides isolation between tool calls.

3. **Sandbox by Removal**: Dangerous functions are set to `nil` in the Lua state, causing calls to fail with "attempt to call nil" errors.

4. **Type Preservation**: Numbers from Lua may be integers or floats depending on the expression. Tests accept both forms.

5. **Table Detection**: Uses sequential integer key detection to distinguish arrays from maps in Lua table results.

## Test Results

```
470 tests, 0 failures
```

All Credo checks pass with `--strict` flag.

## What's Next

Task 3.2.2: Security Boundaries - Implement path validation to ensure file operations stay within project boundaries.
