# Summary: 3.2.3 Erlang Bridge Functions

## Overview

Implemented Erlang-Lua bridge functions that expose controlled file and shell operations to Lua scripts running in the sandbox. All operations validate paths using the Security module before execution.

## Files Created

### lib/jido_code/tools/bridge.ex
Bridge module with functions callable from Lua via the `jido.*` namespace:

- `lua_read_file/3` - Read file contents with path validation
- `lua_write_file/3` - Write file with path validation (creates parent dirs)
- `lua_list_dir/3` - List directory contents (returns 1-indexed Lua array)
- `lua_file_exists/3` - Check path existence
- `lua_shell/3` - Execute shell command with args (runs in project dir)
- `register/2` - Registers all functions in Lua state

Key implementation details:
- Functions return `{[result], state}` or `{[nil, error], state}` format
- Security errors are formatted with user-friendly messages
- Shell commands run via `System.cmd/3` with `cd: project_root`
- Functions wrapped with `{:erl_func, Fun}` for luerl compatibility

### test/jido_code/tools/bridge_test.exs
36 tests covering:
- File operations (read, write, list, exists)
- Security boundary enforcement
- Shell command execution
- Error handling for invalid arguments
- Lua integration (registration and calling)

## Design Decisions

1. **Separate Bridge Module**: Bridge functions in their own module rather than inside Manager for clarity and reusability.

2. **Function Signature Pattern**: All bridge functions follow `(args, state, project_root)` pattern for consistency.

3. **Error Format**: Returns `{[nil, error_message], state}` allowing Lua scripts to handle errors gracefully:
   ```lua
   local content, err = jido.read_file("missing.txt")
   if err then print("Error:", err) end
   ```

4. **Path Validation Integration**: All file operations delegate to `Security.validate_path/3` before performing any I/O.

5. **Lua Array Format**: `list_dir` returns `[{1, "file1"}, {2, "file2"}]` format for Lua compatibility.

6. **Shell Result Format**: Returns `[{"exit_code", n}, {"stdout", "..."}, {"stderr", "..."}]`.

7. **HTTP Deferred**: HTTP bridge (`bridge_http/2`) not implemented - not needed for POC.

## Known Limitations

1. **Luerl State Propagation**: When bridge functions allocate new tables via `:luerl.encode/2`, the table references may not be accessible in Lua after the function returns due to luerl's state handling. Return values that don't require table allocation (strings, booleans, nil) work correctly.

2. **Shell Timeout**: The `_timeout` parameter is parsed but not enforced yet. `System.cmd/3` doesn't have built-in timeout; would need Task wrapper or external solution.

3. **No Stderr Capture**: Currently `stderr_to_stdout: false` but stderr is always empty string. Proper stderr capture would require running via shell.

## Test Results

```
548 tests, 0 failures
```

All Credo checks pass with `--strict` flag.

## What's Next

Task 3.3.1: File System Tools - Create the actual tool definitions that use these bridge functions and expose them to the LLM agent via the tool registry.
