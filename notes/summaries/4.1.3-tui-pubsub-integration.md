# Summary: 4.1.3 TUI PubSub Integration

## Overview

Connected the TUI to the agent system via Phoenix PubSub for real-time updates. Created a bridge module to forward PubSub messages to the TermUI Elm component since TermUI's Elm architecture doesn't natively support `handle_info` for external messages.

## Implementation

### Architecture

TermUI's Elm architecture only processes terminal events via `event_to_msg/2`. PubSub messages arrive as Erlang messages which wouldn't reach Elm components. Solution: Create a bridge GenServer.

```
Agent Process → Phoenix.PubSub → PubSubBridge → TermUI.Runtime → TUI.update/2
```

### PubSubBridge Module

Created `JidoCode.TUI.PubSubBridge` (`lib/jido_code/tui/pubsub_bridge.ex`):
- GenServer that subscribes to `"tui.events"` topic
- Forwards messages to TUI Runtime via `TermUI.Runtime.send_message/3`
- Handles 4 message types, ignores unknown messages

### Updated TUI.run/0

The `run/0` function now:
1. Starts TermUI Runtime with registered name (`JidoCode.TUI.Runtime`)
2. Monitors runtime process
3. Starts PubSubBridge pointing to runtime
4. Blocks until runtime exits, then stops bridge

### PubSub Message Handlers

Added `update/2` handlers for PubSub messages:

| Message | Action |
|---------|--------|
| `{:agent_response, content}` | Add assistant message, set status to :idle |
| `{:agent_status, status}` | Update agent_status (:idle/:processing/:error) |
| `{:reasoning_step, step}` | Add/update reasoning step for CoT display |
| `{:config_changed, config}` | Update config, re-determine status |

### Reasoning Steps

Reasoning steps support two formats:
- Map: `%{step: "text", status: :pending|:active|:complete}` - full control
- String: `"step text"` - added as pending

Steps with matching text are updated rather than duplicated.

## Files Changed

- `lib/jido_code/tui.ex` - Updated run/0, removed PubSub subscription from init, added update handlers
- `lib/jido_code/tui/pubsub_bridge.ex` - New bridge GenServer
- `test/jido_code/tui_test.exs` - Added 14 new tests for PubSub handlers (39 total)
- `test/jido_code/tui/pubsub_bridge_test.exs` - New test file for bridge (5 tests)
- `notes/planning/proof-of-concept/phase-04.md` - Task marked complete
- `notes/features/4.1.3-tui-pubsub-integration.md` - Planning document

## Tests Added

### PubSubBridge Tests (5 tests)
- Forwards agent_response to runtime
- Forwards agent_status to runtime
- Forwards reasoning_step to runtime
- Forwards config_changed to runtime
- Ignores unknown messages

### TUI PubSub Handler Tests (14 tests)
- agent_response adds message to history
- agent_response appends to existing messages
- agent_status updates status
- reasoning_step adds new step
- reasoning_step updates existing step
- reasoning_step handles string format
- config_changed with atom keys
- config_changed with string keys
- config_changed sets unconfigured when nil

## Design Decisions

1. **Bridge pattern**: Rather than modifying TermUI, created an external bridge that integrates cleanly with the existing architecture
2. **Named runtime**: Using `JidoCode.TUI.Runtime` allows bridge to find runtime without coupling
3. **Message forwarding**: Uses TermUI's `send_message/3` API to route messages to root component
4. **Config key flexibility**: Handles both atom and string keys for config_changed

## Next Steps

Task 4.2.1 will implement the main layout structure:
- Three-pane layout: status, conversation, input
- Message display with role indicators
- Proper text wrapping and styling
