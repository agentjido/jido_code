# Summary: 5.2.1 Command Parser

## Overview

Implemented slash command parsing and execution in the TUI. Users can now configure LLM provider and model at runtime using `/` prefixed commands.

## Files Created

### lib/jido_code/commands.ex

New module for command parsing and execution:

**Public API:**
```elixir
@spec execute(String.t(), config()) :: result()
def execute(command, config)
```

**Supported Commands:**
| Command | Description |
|---------|-------------|
| `/help` | List available commands |
| `/config` | Display current provider and model |
| `/provider <name>` | Set provider (clears model) |
| `/model <provider>:<model>` | Set both provider and model |
| `/model <model>` | Set model for current provider |
| `/models` | List models for current provider |
| `/models <provider>` | List models for specified provider |
| `/providers` | List available providers |

**Key Implementation Details:**
- Commands return `{:ok, message, new_config}` or `{:error, message}`
- Provider validation uses `Jido.AI.Model.Registry.Adapter.list_providers/0`
- Model validation skipped for flexibility (actual validation at LLM call time)
- Settings persisted via `JidoCode.Settings.set/3`
- Unknown commands show error with `/help` hint

### test/jido_code/commands_test.exs

New test file with 20 tests covering:
- `/help` returns command list
- `/config` shows current configuration
- `/provider` with valid/invalid providers
- `/model` with various formats
- `/models` and `/providers` listing
- Unknown command handling
- Config key format variations (atom vs string keys)

## Files Modified

### lib/jido_code/tui.ex

Updated command handling integration:

**New Alias:**
```elixir
alias JidoCode.Commands
```

**Updated `handle_command/2`:**
```elixir
defp handle_command(text, state) do
  case Commands.execute(text, state.config) do
    {:ok, message, new_config} ->
      # Display message, update config, determine new status

    {:error, error_message} ->
      # Display error message
  end
end
```

**Key Changes:**
- Delegates to `Commands.execute/2` instead of stub
- Merges returned config with current state
- Updates `agent_status` based on new config
- Displays command result or error as system message

### test/jido_code/tui_test.exs

Updated test setup and added command integration tests:

**Setup Changes:**
- Added settings file backup/restore to avoid test interference
- Commands tests write to settings file during execution

**New Tests (4):**
- `/config` command shows current configuration
- `/provider` command updates config and status
- `/model provider:model` command updates config and status
- Unknown command shows error

**Updated Tests:**
- `handles command input with / prefix` - now expects "Available commands"

## Command Flow

```
User types "/model anthropic:claude-3-5-sonnet"
    ↓
TUI.update({:submit}, state)
    ↓
handle_command(text, state)
    ↓
Commands.execute("/model anthropic:claude-3-5-sonnet", config)
    ↓
Validate provider (check registry)
    ↓
Save to settings (Settings.set/3)
    ↓
Return {:ok, "Model set to anthropic:claude-3-5-sonnet", %{provider: "anthropic", model: "claude-3-5-sonnet"}}
    ↓
TUI updates config, determines status, displays message
```

## Test Coverage

| File | Tests |
|------|-------|
| commands_test.exs | 20 |
| tui_test.exs | 163 (+4 command tests) |
| **Total** | 183 tests, 0 failures |

## Notes

- Pick-list modals for `/models` and `/providers` are pending term_ui refactoring (Task 4.3.1)
- Currently these commands show text lists instead
- Model validation is intentionally lenient - users can specify any model their API key supports
- Provider validation checks against ReqLLM registry (56 providers)
- Similar provider/model suggestions shown on validation failure
- Submit handlers (`do_handle_command`, `do_handle_chat_submit`, etc.) moved after all `update/2` clauses to fix compiler warning about ungrouped clauses
