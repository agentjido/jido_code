# Summary: 5.2.2 Model Switching

## Overview

Extended the Commands module to fully implement model switching with API key validation, agent reconfiguration, and config broadcasting.

## Changes Made

### lib/jido_code/commands.ex

Added the following functionality:

1. **API Key Validation** (`validate_api_key/1`)
   - Checks if API key exists for the selected provider via `Jido.AI.Keyring.get/2`
   - Returns helpful error message with environment variable name if missing
   - Maps provider names to key names (e.g., "anthropic" â†’ `:anthropic_api_key`)

2. **Agent Reconfiguration** (`configure_agent/1`)
   - Looks up running LLMAgent via `AgentSupervisor.lookup_agent/1`
   - Calls `LLMAgent.configure/2` with new provider/model settings
   - Handles agent-not-running case gracefully

3. **Config Broadcast** (`broadcast_config_change/1`)
   - Broadcasts `{:config_changed, config}` via Phoenix.PubSub
   - Uses `tui.events` topic for TUI listeners

### Test Updates

- **test/jido_code/commands_test.exs**: Added API key setup/cleanup helpers using `Keyring.set_session_value/3`
- **test/jido_code/tui_test.exs**: Added same helpers for TUI tests that invoke model switching
- Added test for API key validation error case

## Technical Details

### Provider to Key Name Mapping

```elixir
"openai" -> :openai_api_key
"anthropic" -> :anthropic_api_key
"openrouter" -> :openrouter_api_key
# ... and 10+ more providers
```

### Validation Flow

1. Validate provider exists in registry
2. Validate model (skipped for flexibility - deferred to LLM call)
3. Validate API key exists via Keyring
4. Save settings
5. Configure running agent
6. Broadcast config change

## Test Results

- 889 tests, 0 failures, 2 skipped
- New tests: API key validation error case
- Updated tests: Model switching tests now set up session API keys

## Files Modified

- `lib/jido_code/commands.ex` - Added validation, configuration, and broadcast
- `test/jido_code/commands_test.exs` - Added API key helpers and tests
- `test/jido_code/tui_test.exs` - Added API key helpers for model switch tests
- `notes/planning/proof-of-concept/phase-05.md` - Marked task 5.2.2 complete
- `notes/features/5.2.2-model-switching.md` - Updated status to complete
