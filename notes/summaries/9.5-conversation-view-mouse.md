# Summary: ConversationView Mouse Event Handling (Phase 9.5)

## Overview

Implemented mouse interactions for the ConversationView widget, including mouse wheel scrolling, scrollbar click handling (page up/down), scrollbar drag-to-scroll, and content click for message focus.

## Changes Made

### Files Modified

- **`lib/jido_code/tui/widgets/conversation_view.ex`**
  - Added `handle_event/2` implementations for mouse events:
    - `:scroll_up` / `:scroll_down` - scroll by configurable scroll_lines
    - `:click` - scrollbar page up/down or content focus
    - `:press` - start scrollbar drag
    - `:drag` - update scroll offset proportionally
    - `:release` - end scrollbar drag
  - Added private helper functions:
    - `handle_mouse_click/3` - dispatch scrollbar vs content clicks
    - `handle_mouse_press/3` - handle press for drag initiation
    - `handle_scrollbar_click/2` - page up/down based on click position
    - `handle_scrollbar_press/2` - start drag on thumb press
    - `handle_mouse_drag/2` - proportional scroll during drag
    - `handle_content_click/3` - set message focus from click position
    - `find_message_index_at_line/2` - locate message at absolute line

- **`test/jido_code/tui/widgets/conversation_view_test.exs`**
  - Added 16 new tests for mouse event handling
  - Total: 169 tests (153 from previous sections + 16 from 9.5)

### Files Updated

- **`notes/planning/proof-of-concept/phase-09.md`** - Marked all 9.5 tasks as complete
- **`notes/features/conversation-view-mouse.md`** - Updated status to COMPLETE

## Technical Implementation

### Mouse Wheel Scrolling

Uses the configurable `scroll_lines` prop (default: 3):

```elixir
def handle_event(%TermUI.Event.Mouse{action: :scroll_up}, state) do
  {:ok, scroll_by(state, -state.scroll_lines)}
end

def handle_event(%TermUI.Event.Mouse{action: :scroll_down}, state) do
  {:ok, scroll_by(state, state.scroll_lines)}
end
```

### Scrollbar Click Regions

Click handling based on thumb position:

```elixir
defp handle_scrollbar_click(state, y) do
  {thumb_size, thumb_pos} = calculate_scrollbar_metrics(state, state.viewport_height)

  cond do
    y < thumb_pos -> {:ok, scroll_by(state, -state.viewport_height)}  # Page up
    y >= thumb_pos + thumb_size -> {:ok, scroll_by(state, state.viewport_height)}  # Page down
    true -> {:ok, state}  # On thumb - no action
  end
end
```

### Scrollbar Drag

Three-phase drag handling:
1. **Press on thumb** - Start drag, record `drag_start_y` and `drag_start_offset`
2. **Drag** - Calculate proportional scroll: `offset_change = delta_y * max_offset / track_height`
3. **Release** - End drag, clear drag state

```elixir
defp handle_mouse_drag(state, y) do
  delta_y = y - state.drag_start_y
  offset_change = round(delta_y * max_offset / track_height)
  new_offset = clamp_scroll(state.drag_start_offset + offset_change, state)
  {:ok, %{state | scroll_offset: new_offset}}
end
```

### Content Click Focus

Determines clicked message from click position and scroll offset:

```elixir
defp handle_content_click(state, _x, y) do
  absolute_line = y + state.scroll_offset
  line_info = get_message_line_info(state)
  message_idx = find_message_index_at_line(line_info, absolute_line)
  {:ok, %{state | cursor_message_idx: message_idx}}
end
```

## Mouse Event Summary

| Event | Scrollbar (x >= content_width) | Content Area (x < content_width) |
|-------|-------------------------------|----------------------------------|
| scroll_up | Scroll up by scroll_lines | Scroll up by scroll_lines |
| scroll_down | Scroll down by scroll_lines | Scroll down by scroll_lines |
| click | Page up/down based on position | Set message focus |
| press | Start drag if on thumb | Set message focus |
| drag | Proportional scroll if dragging | Ignored |
| release | End drag if dragging | Ignored |

## Test Coverage

All 169 tests passing:

### Mouse Wheel Tests (5 tests)
- scroll_up decreases offset
- scroll_down increases offset
- Respects lower/upper bounds
- scroll_lines is configurable

### Scrollbar Click Tests (2 tests)
- Click above thumb pages up
- Click below thumb pages down

### Scrollbar Drag Tests (4 tests)
- Press on thumb starts drag
- Drag updates offset proportionally
- Release ends drag state
- Drag respects scroll bounds

### Content Click Tests (3 tests)
- Click sets cursor_message_idx
- Works with scroll offset
- No-op on empty messages

### Catch-All Tests (2 tests)
- Drag without dragging state ignored
- Release without dragging state ignored

## Branch

`feature/conversation-view-mouse`

## Notes

- Double-click to copy was skipped for simplicity (y key already provides copy)
- Click on truncation indicator to expand was skipped (Space key provides toggle)
- Scrollbar arrows were not implemented (minimal design choice from 9.3)
